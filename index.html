<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>두레팜 - AI 폐자원 수거 플랫폼 (개선 버전)</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (지도 라이브러리) CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js (차트 라이브러리) CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons (아이콘 라이브러리) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 기본 폰트 설정 */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* 스크롤바 숨기기 */
        body::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        /* Leaflet 지도 컨테이너 높이 설정 */
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
        }
        /* 인터랙션 효과를 위한 transition */
        .interactive-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .interactive-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 flex">

    <!-- 사이드바 -->
    <aside class="w-64 bg-gray-900 text-gray-300 flex flex-col p-4 fixed h-full shadow-lg">
        <div class="flex items-center mb-10">
            <i data-lucide="recycle" class="w-10 h-10 mr-3 text-green-400"></i>
            <h1 class="text-2xl font-bold text-white">두레팜</h1>
        </div>
        <nav class="flex-grow">
            <ul>
                <li class="mb-3"><a href="#" class="flex items-center py-2 px-4 text-white bg-green-600 rounded-lg font-semibold"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>대시보드</a></li>
                <li class="mb-3"><a href="#" class="flex items-center py-2 px-4 hover:bg-gray-700 rounded-lg"><i data-lucide="map" class="w-5 h-5 mr-3"></i>수거 경로</a></li>
                <li class="mb-3"><a href="#" class="flex items-center py-2 px-4 hover:bg-gray-700 rounded-lg"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>생산 분석</a></li>
                <li class="mb-3"><a href="#" class="flex items-center py-2 px-4 hover:bg-gray-700 rounded-lg"><i data-lucide="users" class="w-5 h-5 mr-3"></i>농가 관리</a></li>
                <li class="mb-3"><a href="#" class="flex items-center py-2 px-4 hover:bg-gray-700 rounded-lg"><i data-lucide="settings" class="w-5 h-5 mr-3"></i>설정</a></li>
            </ul>
        </nav>
        <div class="mt-auto">
            <div class="bg-gray-800 p-4 rounded-lg text-center">
                <i data-lucide="truck" class="w-12 h-12 mx-auto text-green-400"></i>
                <p class="mt-2 text-sm text-gray-400">실시간 수거 현황</p>
                <button class="mt-3 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full">
                    상세 보기
                </button>
            </div>
        </div>
    </aside>

    <!-- 메인 콘텐츠 -->
    <main class="ml-64 flex-1 p-8">
        <!-- 헤더 -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">AI 수거 통합 플랫폼</h2>
                <p id="last-updated" class="text-sm text-gray-500">마지막 업데이트: </p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                    <input type="text" placeholder="검색..." class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <button class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="bell" class="text-gray-600"></i></button>
                <div class="flex items-center space-x-2">
                    <img src="https://placehold.co/40x40/A7F3D0/1F2937?text=H" alt="User Avatar" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-semibold text-gray-700">황진경</p>
                        <p class="text-sm text-gray-500">대표</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- 대시보드 그리드 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- AI 기반 분석 -->
            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-5 rounded-xl shadow-md flex items-center interactive-card">
                    <div class="p-3 rounded-full bg-green-100 mr-4"><i data-lucide="package" class="w-8 h-8 text-green-600"></i></div>
                    <div>
                        <p class="text-sm text-gray-500">총 수거량 (톤)</p>
                        <p class="text-2xl font-bold text-gray-800">875</p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-md flex items-center interactive-card">
                    <div class="p-3 rounded-full bg-blue-100 mr-4"><i data-lucide="flame" class="w-8 h-8 text-blue-600"></i></div>
                    <div>
                        <p class="text-sm text-gray-500">펠릿 생산량 (톤)</p>
                        <p class="text-2xl font-bold text-gray-800">230</p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-md flex items-center interactive-card">
                    <div class="p-3 rounded-full bg-yellow-100 mr-4"><i data-lucide="truck" class="w-8 h-8 text-yellow-600"></i></div>
                    <div>
                        <p class="text-sm text-gray-500">운행 차량</p>
                        <p class="text-2xl font-bold text-gray-800">12 / 15</p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-md flex items-center interactive-card">
                    <div class="p-3 rounded-full bg-red-100 mr-4"><i data-lucide="leaf" class="w-8 h-8 text-red-600"></i></div>
                    <div>
                        <p class="text-sm text-gray-500">탄소 절감량 (tCO2)</p>
                        <p class="text-2xl font-bold text-gray-800">96</p>
                    </div>
                </div>
            </div>

            <!-- 지도 -->
            <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-md h-[500px]">
                <div id="map"></div>
            </div>

            <!-- 수거 경로 정보 -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-xl font-bold text-gray-800 mb-4">실시간 수거 경로</h3>
                <div class="space-y-4">
                    <div class="border p-4 rounded-lg interactive-card cursor-pointer">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-gray-700">경남 서부권</p>
                            <span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-1 rounded-full">진행 중</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">담당: 김철수 (12가 3456)</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div class="bg-green-500 h-2.5 rounded-full" style="width: 75%"></div>
                        </div>
                        <p class="text-right text-sm text-gray-500 mt-1">7/10 농가 완료</p>
                    </div>
                    <div class="border p-4 rounded-lg interactive-card cursor-pointer">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-gray-700">경남 동부권</p>
                            <span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">대기 중</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">담당: 박영희 (34나 5678)</p>
                         <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div class="bg-blue-500 h-2.5 rounded-full" style="width: 10%"></div>
                        </div>
                        <p class="text-right text-sm text-gray-500 mt-1">1/12 농가 완료</p>
                    </div>
                    <div class="border p-4 rounded-lg interactive-card cursor-pointer">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-gray-700">전남권</p>
                            <span class="text-xs font-semibold bg-gray-200 text-gray-800 px-2 py-1 rounded-full">완료</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">담당: 이민준 (56다 7890)</p>
                         <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div class="bg-gray-400 h-2.5 rounded-full" style="width: 100%"></div>
                        </div>
                        <p class="text-right text-sm text-gray-500 mt-1">8/8 농가 완료</p>
                    </div>
                </div>
            </div>

            <!-- 생산량 차트 -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-xl font-bold text-gray-800 mb-4">주요 생산량 추이 (단위: 톤)</h3>
                <div class="h-80"><canvas id="productionYieldChart"></canvas></div>
            </div>

            <!-- 펠릿 상태 차트 -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                 <h3 class="text-xl font-bold text-gray-800 mb-4">펠릿 재고 현황 (단위: 톤)</h3>
                 <div class="h-80"><canvas id="pelletStatesChart"></canvas></div>
            </div>

        </div>
    </main>

    <script>
        // Lucide 아이콘 렌더링
        lucide.createIcons();
        
        // 마지막 업데이트 시간 설정
        document.getElementById('last-updated').textContent = `마지막 업데이트: ${new Date().toLocaleString('ko-KR')}`;

        // --- 지도 (Leaflet.js) 설정 ---
        // 지도 타일 레이어 정의
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // 경상남도 진주시를 중심으로 지도 초기화
        const map = L.map('map', {
            center: [35.1804, 128.0834],
            zoom: 9,
            layers: [osmLayer] // 기본 레이어
        });

        const baseMaps = {
            "일반 지도": osmLayer,
            "위성 지도": satelliteLayer
        };

        L.control.layers(baseMaps).addTo(map);


        // 커스텀 아이콘 정의 (SVG Data URI 사용으로 변경)
        const farmIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#22c55e" width="32px" height="32px"><path d="M21.6,8.2C21.6,8.2,21.6,8.2,21.6,8.2c-0.2-1.9-1.1-3.7-2.6-5.2C17.6,1.6,15.8,0.7,13.8,0.4c-0.1,0-0.2,0-0.3,0 c-0.5,0-1,0-1.5,0.1C9.4,0.7,7,2.2,5.4,4.6C3.9,7,3.9,9.9,5.4,12.3c0,0,0,0,0,0l0,0c1.1,1.8,2.8,3,4.8,3.5V19c0,1.1,0.9,2,2,2h0 c1.1,0,2-0.9,2-2v-3.5c2-0.5,3.7-1.7,4.8-3.5l0,0C20.5,10.6,21.2,9.4,21.6,8.2z"/></svg>`;
        const truckIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 40" fill="#3B82F6" width="40px" height="40px"><path d="M62,28.8H50.2v-5h4.4V19h-4.4v-5h10.6c1.1,0,2-0.9,2-2s-0.9-2-2-2H48.8V5c0-1.1-0.9-2-2-2H2.2C1,3,0,3.9,0,5v23.8 C0,29.9,0.9,31,2,31h6.4c0.8,4.5,4.6,8,9.4,8s8.6-3.5,9.4-8h13.1c0.8,4.5,4.6,8,9.4,8s8.6-3.5,9.4-8H62c1.1,0,2-0.9,2-2 S63.1,28.8,62,28.8z M21.8,35c-2.2,0-4-1.8-4-4s1.8-4,4-4s4,1.8,4,4S24,35,21.8,35z M49.8,35c-2.2,0-4-1.8-4-4s1.8-4,4-4s4,1.8,4,4 S52,35,49.8,35z M4,28.8V5h40.8v23.8H4z"/></svg>`;

        const farmIcon = L.icon({
            iconUrl: `data:image/svg+xml;base64,${btoa(farmIconSVG)}`,
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });
        const truckIcon = L.icon({
            iconUrl: `data:image/svg+xml;base64,${btoa(truckIconSVG)}`,
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });

        // 수거 지점 (농가) 및 경로 데이터
        const farms = [
            { name: "사천시 곤명면 농가", lat: 35.088, lng: 128.085, status: "수거 완료" },
            { name: "진주시 수곡면 농가", lat: 35.192, lng: 128.013, status: "수거 예정" },
            { name: "하동군 옥종면 농가", lat: 35.153, lng: 127.931, status: "수거 예정" },
            { name: "산청군 단성면 농가", lat: 35.263, lng: 128.061, status: "수거 예정" },
            { name: "함양군 유림면 농가", lat: 35.438, lng: 127.876, status: "수거 예정" }
        ];
        const routeLatLngs = farms.map(farm => [farm.lat, farm.lng]);

        // 농가 마커 및 경로 추가
        farms.forEach(farm => L.marker([farm.lat, farm.lng], { icon: farmIcon }).addTo(map).bindPopup(`<b>${farm.name}</b><br>${farm.status}`));
        const route = L.polyline(routeLatLngs, { color: 'blue', weight: 5, opacity: 0.7, dashArray: '10, 5' }).addTo(map);
        
        // 트럭 마커 추가
        const truckMarker = L.marker(routeLatLngs[0], { icon: truckIcon }).addTo(map).bindPopup('<b>경남 서부권 수거 차량</b>');
        map.fitBounds(route.getBounds().pad(0.1));

        // 트럭 이동 애니메이션
        let truckIndex = 0;
        setInterval(() => {
            truckIndex = (truckIndex + 1) % routeLatLngs.length;
            truckMarker.setLatLng(routeLatLngs[truckIndex]);
            if(truckIndex === 0) { // 경로 완주 후 팝업 업데이트
                 truckMarker.bindPopup('<b>경남 서부권 수거 차량</b><br>경로 완주! 대기 중...').openPopup();
            } else {
                 truckMarker.bindPopup(`<b>경남 서부권 수거 차량</b><br>${farms[truckIndex].name}로 이동 중`).openPopup();
            }
        }, 3000); // 3초마다 위치 변경


        // --- 차트 (Chart.js) 설정 ---
        
        // 1. 생산량 추이 차트 (라인 차트)
        const productionCtx = document.getElementById('productionYieldChart').getContext('2d');
        const gradient = productionCtx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(52, 211, 153, 0.5)');
        gradient.addColorStop(1, 'rgba(52, 211, 153, 0)');

        const productionYieldChart = new Chart(productionCtx, {
            type: 'line',
            data: {
                labels: ['1월', '2월', '3월', '4월', '5월', '6월', '7월'],
                datasets: [{
                    label: '폐배지 수거량',
                    data: [120, 150, 180, 160, 210, 250, 230],
                    borderColor: 'rgba(52, 211, 153, 1)',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(52, 211, 153, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(52, 211, 153, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });

        // 2. 펠릿 재고 현황 차트 (수평 막대 차트)
        const pelletCtx = document.getElementById('pelletStatesChart').getContext('2d');
        const pelletStatesChart = new Chart(pelletCtx, {
            type: 'bar',
            data: {
                labels: ['산업용', '가정용', '반려동물용', '미가공'],
                datasets: [{
                    label: '재고 현황 (톤)',
                    data: [120, 45, 30, 80],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(251, 146, 60, 0.8)',
                        'rgba(156, 163, 175, 0.8)'
                    ],
                    borderRadius: 5
                }]
            },
            options: {
                indexAxis: 'y', // 수평 막대그래프로 변경
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    </script>
</body>
</html>
